name: CI/CD Pipeline

    
on:
    push:
      branches:
        - main
    pull_request:
      branches:
        - main


jobs: 
    test:
        runs-on: ubuntu-latest


        steps:
            - name: Checkout Code
              uses: actions/checkout@v3

            - name: Set Up Python
              uses: actions/setup-python@v4
              with:
                python-version: "3.10"

            - name: Install Dependencies
              run: | 
                python -m pip install --upgrade pip
                pip install -r requirements.txt

            - name: Run Tests
              run: |
                PYTHONPATH=. pytest -v
    

    deploy:
      runs-on: ubuntu-latest
      needs: test
      if: success()


      steps:
        - name: Add Server to Known Hosts
          run: |
            mkdir -p ~/.ssh
            ssh-keyscan -H 139.162.134.90 >> ~/.ssh/known_hosts
        - name: SSH and Deploy
          run: |
            ssh -o StrictHostKeyChecking=no -tt root@139.162.134.90 << EOF
              cd /root/CRUD
              git pull origin main
              python3 -m venv venv
              source venv/bin/activate
              pip install -r requirements.txt
            EOF

